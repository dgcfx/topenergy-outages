<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Top Energy Outages</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <style>
    /* General Body Styles */
    body { font-family: system-ui, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; color: #2c3e50; }
    h1 { text-align: center; margin: 10px 0 20px; font-size: 2em; }
    p { text-align: center; }

    /* Tab styles */
    .tab-container { overflow: hidden; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
    .tab-button { background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
    .tab-button:hover { background-color: #ddd; }
    .tab-button.active { background-color: #ccc; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Video Tab Styles */
    video { width: 100%; max-width: 1200px; }
    img { width: 100%; }
    .controls { margin-top: 10px; display: flex; align-items: center; gap: 15px; font-size: 16px; margin-bottom: 20px; }

    /* Calendar Tab Styles from Grok */
    #calendar { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .fc-event{font-weight:600;border:none !important;border-radius:4px;padding:2px 4px;font-size:0.9em;}
    .fc-event.unplanned{background:#e74c3c !important;border-color:#c0392b !important;color:white;}
    .fc-event.planned{background:#3498db !important;border-color:#2980b9 !important;color:white;}
    .fc-toolbar { background: #2c3e50; color: white; }
    .fc-button { background: #34495e !important; border: none !important; }
    .fc-button:hover, .fc-button:active { background: #1abc9c !important; }
    .fc-today-button { background: #27ae60 !important; }
  </style>
</head>
<body>
  <h1>Top Energy Outages</h1>

  <div class="tab-container">
    <button class="tab-button active" onclick="openTab(event, 'Timelapse')">Timelapse</button>
    <button class="tab-button" onclick="openTab(event, 'Calendar')">Calendar</button>
  </div>

  <div id="Timelapse" class="tab-content active">
    <video id="timelapse-video" controls autoplay loop controlsList="nodownload">
      <source src="outages.mp4" type="video/mp4">
      Video still building...
    </video>
    <div class="controls">
      <label for="speed-slider">Playback Speed:</label>
      <input type="range" id="speed-slider" min="0.25" max="4" step="0.25" value="1">
      <span id="speed-display">1.00x</span>
    </div>
    <img src="latest.jpg?v=<%= new Date().getTime() %>" alt="Latest outage map" />
  </div>

  <div id="Calendar" class="tab-content">
    <div id="calendar"></div>
  </div>

  <p><small>Data captured every 15 minutes. Video rebuilt daily. Full raw history in /data/history/</small></p>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script>
    let calendar; // This will hold our calendar instance, accessible to all functions

    // --- Tab switching logic ---
    function openTab(evt, tabName) {
      let i, tabcontent, tabbuttons;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";

      // When the calendar tab is shown, tell the calendar to update its size.
      if (tabName === 'Calendar' && calendar) {
        calendar.updateSize();
      }
    }

    // --- Video playback speed logic ---
    (function() {
      const video = document.getElementById('timelapse-video');
      const speedSlider = document.getElementById('speed-slider');
      const speedDisplay = document.getElementById('speed-display');
      video.playbackRate = speedSlider.value;
      speedSlider.addEventListener('input', function() {
        video.playbackRate = this.value;
        speedDisplay.textContent = parseFloat(this.value).toFixed(2) + 'x';
      });
    })();

    // --- Calendar logic ---
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        height: 'auto', // Let the container's height dictate the size
        editable: false,
        selectable: false,
        dayMaxEvents: true,
        eventClick: info => {
          const e = info.event;
          const ex = e.extendedProps;
          // The 'body' field from our JSON is automatically available in extendedProps
          alert(ex.body);
        }
      });

      fetch('public/outages.json?v=' + new Date().getTime())
        .then(response => response.json())
        .then(data => {
          const eventSource = data.events.map(ev => ({
            ...ev,
            className: ev.extendedProps.type  // this applies the red/blue styling
          }));
          calendar.addEventSource(eventSource);
        });

      calendar.render();
    });
  </script>
</body>
</html>
